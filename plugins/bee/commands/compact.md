---
description: Smart compact -- preserve bee context, then compress conversation
argument-hint: ""
---

## Current State (load before proceeding)

Read these files using the Read tool:
- `.bee/STATE.md` -- if not found: NOT_INITIALIZED
- `.bee/config.json` -- if not found: use `{}`

## Instructions

You are running `/bee:compact` -- a context-aware compact that preserves essential bee project state before compressing the conversation. Follow these steps in order.

### Step 1: Initialization Check

If the state above contains `NOT_INITIALIZED` (meaning `.bee/STATE.md` does not exist):
- Tell the user: "Bee not initialized. Run `/compact` directly to compress the conversation, or `/bee:init` to set up BeeDev first."
- Do NOT write COMPACT-CONTEXT.md.
- Stop here.

### Step 2: Collect Essential Context

Read and extract the following from the files above:

**From STATE.md:**
- Current spec: name, path, status
- Active phase: number, name, status (from Phases table)
- Phase progress: how many complete vs total
- Last action: command, timestamp, result
- Quick tasks: count and last entry (if any)
- Any decisions from the Decisions Log

**From config.json:**
- Stack name
- Any custom settings (review preferences, etc.)

**From git (run via Bash):**
- `git diff --stat` -- count of uncommitted files
- `git branch --show-current` -- current branch

### Step 3: Write `.bee/COMPACT-CONTEXT.md`

Write a concise context file to `.bee/COMPACT-CONTEXT.md` using the Write tool. This file persists on disk and can be read by `/bee:resume`, the PreCompact hook, or any new session.

Format:

```markdown
# Bee Compact Context

> Auto-generated by `/bee:compact` -- do not edit manually.

## Snapshot
- **Timestamp:** {ISO 8601 now}
- **Branch:** {current git branch}
- **Uncommitted:** {count} files

## Project
- **Stack:** {stack from config.json}
- **Spec:** {spec name} ({status})
- **Path:** {spec path}

## Phase Progress
- **Active:** Phase {N}/{total} -- {phase name}
- **Status:** {phase status}
- **Completed:** {list of completed phase numbers, or "none"}

## Last Action
- **Command:** {command}
- **When:** {timestamp}
- **Result:** {result}

## Quick Tasks
{If entries exist: "N completed, last: {description}"}
{If none: "None"}

## Decisions
{If decisions log has entries, list each as "- {decision}"}
{If none: "No decisions logged"}

## Next Step
`/bee:{suggested command}` -- {reason}
```

### Step 4: Output Context to Conversation

After writing the file, output the same content directly in the conversation as a message. This is critical -- the compaction summary will capture it from the message stream.

Display:

```
Bee context saved to .bee/COMPACT-CONTEXT.md

--- BEE CONTEXT (preserved across compact) ---

Project: {directory name} | Stack: {stack}
Spec: {spec name} ({status}) | Path: {spec path}
Phase: {N}/{total} -- {phase name} [{status}]
Branch: {branch} | Uncommitted: {count} files

Last action: {command} ({timestamp})
Result: {result}

{If quick tasks exist:}
Quick tasks: {count} completed, last: "{description}"

{If decisions log has entries:}
Key decisions:
- {decision 1}
- {decision 2}

Next step: /bee:{suggested command} -- {reason}
--- END BEE CONTEXT ---
```

### Step 5: Prompt User to Compact

Display:

```
Context preserved. Run /compact to compress the conversation.

Your bee context is saved in:
- .bee/COMPACT-CONTEXT.md (on disk, survives session crashes)
- The message above (in conversation, survives compaction summary)

After compacting, run /bee:resume if you need a full briefing.
```

Stop here. Do NOT attempt to invoke `/compact` programmatically â€” it is a built-in CLI command that must be run by the user.

---

**Design Notes (do not display to user):**

- Dual persistence: context goes to both disk (`.bee/COMPACT-CONTEXT.md`) and conversation stream. Disk survives session crashes; conversation stream survives compaction summaries.
- `.bee/COMPACT-CONTEXT.md` replaces `.bee/SESSION-CONTEXT.md` as the richer context snapshot. SESSION-CONTEXT.md (from PreCompact hook) is a raw dump; COMPACT-CONTEXT.md is curated and structured.
- `/bee:resume` can read COMPACT-CONTEXT.md for a better briefing than SESSION-CONTEXT.md alone.
- The context block format is intentionally terse -- one line per concept, no prose. Maximizes information density in both the file and the compacted summary.
- Git state is included because the user needs to know what's dirty after compact.
- The "Next step" line uses the same routing logic as `/bee:progress`.
- If NOT_INITIALIZED, Step 1 guard tells the user to run `/compact` directly or `/bee:init` first. No context file is written.
- COMPACT-CONTEXT.md is overwritten on each `/bee:compact` run (always reflects latest state).
